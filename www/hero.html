<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>도탑전기</title>
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css">
<link rel="stylesheet" href="css/dtcq.css">
<link rel="stylesheet" href="css/listview-grid.css">
<script src="js/jquery-1.11.2.min.js"></script>
<script src="js/assets/index.js"></script>
<script src="js/jquery.mobile-1.4.5.min.js"></script>
<script src="js/knockout.js"></script>
<script src="js/underscore.js"></script>
<script src="js/jquery.raty.js"></script>
<script src="js/scripts.js"></script>
</head>
<body>

<div data-role="page" class="jqm-demos jqm-home dtcq-page" id="hero" data-theme="b">

	<div data-role="header" class="jqm-header">
		<h2><a href="index.html"><img src="img/logo.png" alt="jQuery Mobile"></a></h2>
		<a href="#" class="jqm-navmenu-link ui-btn ui-btn-icon-notext ui-corner-all ui-icon-bars ui-nodisc-icon ui-alt-icon ui-btn-left">Menu</a>
		<a href="#" class="ui-btn ui-btn-icon-notext ui-corner-all ui-icon-arrow-l ui-nodisc-icon ui-btn-right" data-rel="back" data-direction="reverse">Back</a>
	</div><!-- /header -->

	<div role="main" class="ui-content jqm-content">
		<div class="dtcq-hero-detail" id="hero-detail">
			<div class="dtcq-hero-detail-header">
				<div class="dtcq-hero-detail-description">
					<h2 class="dtcq-hero-name"></h2>
					<p><img class="dtcq-hero-type-img"> <span class="dtcq-hero-position"></span></p>
				</div>
			</div>
			<div class="dtcq-section dtcq-hero-stats">
				<div class="dtcq-section-head">
					<h4>영웅 능력치</h4>
				</div>
				<div class="dtcq-section-inner">
					<div class="dtcq-hero-rating">
						<div id="star-placeholder"></div>
						<div id="star-level"></div>
					</div>
					<div class="dtcq-chart">
						<div class="dtcq-chart-bar">
							<div class="stats-bar">
								<label for="strength">STR <span data-bind="text: cursor().growth.str"></span></label>
								<span class="bar-wrap"><span class="bar" id="strength"></span></span>
							</div>
							<div class="stats-bar">
								<label for="intellect">INT <span data-bind="text: cursor().growth.int"></span></label>
								<span class="bar-wrap"><span class="bar" id="intellect"></span></span>
							</div>
							<div class="stats-bar">
								<label for="agility">AGI <span data-bind="text: cursor().growth.agi"></span></label>
								<span class="bar-wrap"><span class="bar" id="agility"></span></span>
							</div>
						</div>
					</div>
					<div class="dtcq-column">
						<div class="column">
							<table>
								<tbody>
									<tr>
										<th>힘:</th>
										<td data-bind="text: cursor().details.str"></td>
									</tr>
									<tr>
										<th>지능:</th>
										<td data-bind="text: cursor().details.int"></td>
									</tr>
									<tr>
										<th>민첩:</th>
										<td data-bind="text: cursor().details.agi"></td>
									</tr>
								</tbody>
							</table>
						</div>
						<div class="column">
							<table>
								<tbody>
									<tr>
										<th>최대체력:</th>
										<td data-bind="text: cursor().details.hp"></td>
									</tr>
									<tr>
										<th>물리공격:</th>
										<td data-bind="text: cursor().details.ad"></td>
									</tr>
									<tr>
										<th>마법강도:</th>
										<td data-bind="text: cursor().details.ap"></td>
									</tr>
								</tbody>
							</table>
						</div>
						<div class="column">
							<table>
								<tbody>
									<tr>
										<th>물리방어:</th>
										<td data-bind="text: cursor().details.arm"></td>
									</tr>
									<tr>
										<th>마법저항:</th>
										<td data-bind="text: cursor().details.mr"></td>
									</tr>
									<tr>
										<th>물리치명타:</th>
										<td data-bind="text: cursor().details.crit"></td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
			<div class="dtcq-row">
				<div class="dtcq-section dtcq-hero-soulstones">
					<div class="dtcq-section-head">
						<h4>영혼석</h4>
					</div>
					<div class="dtcq-section-inner">
						<ul data-bind="foreach: soulstones">
							<li data-bind="text: location"></li>
						</ul>
					</div>
				</div>
				<div class="dtcq-section dtcq-hero-reviews">
					<div class="dtcq-section-head">
						<h4>리뷰</h4>
					</div>
					<div class="dtcq-section-inner">
						<table>
							<tbody>
								<tr>
									<th>추천레벨</th>
									<td><div id="raty-recommend"></div></td>
								</tr>
								<tr>
									<th>습득난이도</th>
									<td><div id="raty-start-difficulty"></div></td>
								</tr>
								<tr>
									<th>진화난이도</th>
									<td><div id="raty-grow-difficulty"></div></td>
								</tr>
								<tr>
									<th>데미지</th>
									<td><div id="raty-damage"></div></td>
								</tr>
								<tr>
									<th>팀서포트</th>
									<td><div id="raty-assist"></div></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="dtcq-section dtcq-hero-skill">
				<div class="dtcq-section-head">
					<h4>영웅 스킬</h4>
				</div>
				<div class="dtcq-section-inner" data-bind="foreach: skills">
					<div class="dtcq-section-row">
						<div class="skill-icon">
							<img data-bind="attr: {src: thumbnail}">
						</div>
						<dl>
							<dt data-bind="text: name"></dt>
							<dd data-bind="text: description"></dd>
						</dl>
					</div>
				</div>
			</div>
			<div class="dtcq-section dtcq-hero-equip">
				<div class="dtcq-section-head">
					<h4>등급별 착용 아이템</h4>
				</div>
				<div class="dtcq-section-inner">
					<div data-bind="foreach: grades">
						<div class="dtcq-hero-equip-row">
							<div class="dtcq-hero-grade">
								<div class="dtcq-hero-thumb">
									<span class="dtcq-thumb"><img data-bind="attr: {src: thumbnail}"></span>
									<span class="dtcq-frame"><img data-bind="attr: {src: frame}"></span>
								</div>
								<div data-bind="attr: {class: 'label label' + id}, text: name"></div>
							</div>
							<div class="dtcq-hero-upgrade">
								<ul class="dtcq-list dtcq-grid-2" data-bind="foreach: props">
									<li>
										<a href="#" data-bind="attr: {href: href, value: id}">
											<span class="dtcq-thumb"><img data-bind="attr: {src: icon}"></span>
											<span class="dtcq-frame"><img data-bind="attr: {src: frame}"></span>
										</a>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

	</div><!-- /content -->

	<div data-role="panel" class="jqm-navmenu-panel" data-position="left" data-display="push" data-animate="true">
		<ul class="jqm-list ui-alt-icon ui-nodisc-icon">
			<li data-filtertext="도탑전기 영웅DB"><a href="index.html">영웅DB</a></li>
			<li data-filtertext="도탑전기 아이템DB"><a href="props.html">아이템DB</a></li>
			<li data-filtertext="도탑전기 던전DB"><a href="stages.html">던전DB</a></li>
		</ul>
	</div><!-- /panel -->

	<div data-role="footer" data-position="fixed" data-tap-toggle="false" class="jqm-footer">
		<div id="ad">
		</div>
	</div><!-- /footer -->

	<script>
	function init_page(attributes, raty_icon_path, initial_stars, rates, grades, soulstones, skills) {
		var QUALITIES = {
			'1': 'white', '2': 'green', '3': 'blue', '4': 'purple', '5': 'purple', '6': 'orange'
		};

		function HeroAttr(data, level) {
			if (data) {
				this.star = data.star;
				this.growth = data.growth;
				//his.rates = data.rates;
				if (level === 'min_level') {
					this.details = data.min_level;
				}
			}
		}

		function Soulstone(data) {
			this.location = (data.stage_type == 2 ? '[일반]' : '<span class="herioc">[정예]</span>') + ' 제' + data.chapter + '장' + ' ' + data.name;
		}

		function Skill(data) {
			this.name = data.name;
			this.description = data.description;
			this.thumbnail = data.thumbnail;
		}

		function Grade(data) {
			this.id = data.id;
			this.name = data.name;
			this.props = data.props;
			this.thumbnail = data.thumbnail;
			this.frame = 'img/ui/thumb/frame_' + this.id + '.png';

			for (var i = 0; i < this.props.length; i++) {
				var p = this.props[i];

				this.props[i].icon = p.icon;
				this.props[i].href = 'prop.html?id=' + p.id;
				this.props[i].frame = 'img/ui/equip/frame_' + QUALITIES[p.quality] + '.png';
			}
		}

		function viewModel(attrs) {
			var self = this;

			self.attrs = attrs;
			self.cursor = ko.observable();
			self.hero = [];
			self.reviews = [];
			self.attributes = [];
			self.soulstones = [];
			self.skills = [];
			self.grades = [];

			self.set = function(star, level) {;
				if (star < initial_stars) {
					star = initial_stars;
				}

				if (!level || typeof level !== 'string' || !_.contains(['min_level', 'max_level'], level)) {
					level = 'min_level';
				}

				self.cursor(new HeroAttr(self.attrs[star - 1], level));
			};

			self.current = function() {
				return self.cursor();
			}

			self.set(0, 'min_level');

			for (var i = 0; i < skills.length; i++) {
				self.skills.push(new Skill(skills[i]));
			}
			for (var i = 0; i < soulstones.length; i++) {
				self.soulstones.push(new Soulstone(soulstones[i]));
			}
			for (var i = 0; i < grades.length; i++) {
				self.grades.push(new Grade(grades[i]));
			}
		}

		var vm = new viewModel(attributes);
		ko.applyBindings(vm, document.getElementById('hero-detail'));

		var growth = vm.current().growth;
		document.getElementById('strength').style.width = growth.str * 10 + '%';
		document.getElementById('intellect').style.width = growth.int * 10 + '%';
		document.getElementById('agility').style.width = growth.agi * 10 + '%';

		var level = 'min_level';
		var offset_score = initial_stars - 1;

		if (offset_score > 0) {
			$('#star-placeholder').raty({
				path: raty_icon_path,
				score: offset_score,
				number: offset_score,
				hints: [initial_stars, initial_stars, initial_stars, initial_stars, initial_stars],
				readOnly: true
			});
		}

		// Raty
		$('#star-level').raty({
			path: raty_icon_path,
			score: 1,
			number: 5 - offset_score,
			hints: [initial_stars, initial_stars, initial_stars, initial_stars, initial_stars],
			mouseover: function(score, e) {
				$(this).raty('score', score);
				vm.set(offset_score + score, level);
				var growth = vm.current().growth;
				document.getElementById('strength').style.width = growth.str * 10 + '%';
				document.getElementById('intellect').style.width = growth.int * 10 + '%';
				document.getElementById('agility').style.width = growth.agi * 10 + '%';
			}
		});

		$('#raty-recommend').raty({path: raty_icon_path, score: rates['recommend'], readOnly: true});
		$('#raty-start-difficulty').raty({path: raty_icon_path, score: rates['start_difficulty'], readOnly: true});
		$('#raty-grow-difficulty').raty({path: raty_icon_path, score: rates['upgrade_difficulty'], readOnly: true});
		$('#raty-damage').raty({path: raty_icon_path, score: rates['damage'], readOnly: true});
		$('#raty-assist').raty({path: raty_icon_path, score: rates['assistant'], readOnly: true});
		$(window).resize(); // Hack to make jquery.equalizer works normally
	}

	$(document).on('pageinit', '#hero', function() {
		var query = location.href.split("?")[1].replace('id=', '');
		$.getJSON('http://dotopstory.cafe24.com/docs/api/hero/' + query, function(data) {
			var attributes = data.attributes;
			var rates = data.reviews;
			var soulstones = data.soulstones;
			var skills = data.skills;
			var grades = data.grades;
			var raty_icon_path = 'img/raty';
			var initial_stars = data.hero.star;
			init_page(attributes, raty_icon_path, initial_stars, rates, grades, soulstones, skills);
			$('.dtcq-hero-name').html(data.hero.name);
			$('.dtcq-hero-type-img').attr('src', 'img/icon_' + data.hero.type + '.gif');
			$('.dtcq-hero-position').html(data.hero.position);
			$('.dtcq-hero-detail-header').css('background-image', 'url(\'img/arts/' + data.hero.title + '.jpg\')');
		});
	});
	</script>

</div>

</body>
</html>